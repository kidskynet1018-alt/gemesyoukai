<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>2äººéº»é›€ï¼ˆCPUå¯¾æˆ¦ï¼‰</title>
  <style>
    body { font-family: sans-serif; background: #0a8f3e; color: white; text-align: center; };
    .hand, .discard { display: flex; justify-content: center; margin: 10px; flex-wrap: wrap; };
    .tile { 
      width: 40px; height: 60px; margin: 2px; 
      background: white; color: black; border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
    };
    .cpu-hand .tile { background: gray; }; /* CPUã®æ‰‹ç‰Œã¯è£ */
    .section { margin: 15px 0; };
    h2 { margin: 5px; };
  </style>
</head>

<body>
  <h1>2äººéº»é›€ï¼ˆCPUå¯¾æˆ¦ï¼‰</h1>

  <div class="section">
    <h2>CPUã®æ‰‹ç‰Œ</h2>
    <div id="cpu-hand" class="hand cpu-hand"></div>

    <h3>CPUã®æ¨ã¦ç‰Œ</h3>
    <div id="cpu-discards" class="discard"></div>
  </div>

  <hr>

  <div class="section">
    <h3>ã‚ãªãŸã®æ¨ã¦ç‰Œ</h3>
    <div id="player-discards" class="discard"></div>

    <h2>ã‚ãªãŸã®æ‰‹ç‰Œ</h2>
    <div id="player-hand" class="hand"></div>

    <button id="draw-btn">ãƒ„ãƒ¢</button>
  </div>

  <script>
    // ====== ç‰Œãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ ======
    const suits = ['m', 'p', 's']; // è¬ãƒ»ç­’ãƒ»ç´¢
    const tiles = [];

    for (let suit of suits) {
      for (let num = 1; num <= 9; num++) {
        for (let i = 0; i < 4; i++) {
          tiles.push(suit + num);
        };
      };
    };

    const honors = ['æ±', 'å—', 'è¥¿', 'åŒ—', 'ç™½', 'ç™¼', 'ä¸­']; // æ±å—è¥¿åŒ—ç™½ç™¼ä¸­
    for (let h of honors) {
      for (let i = 0; i < 4; i++) {
        tiles.push(h);
      };
    };

    // ====== å±±ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ« ======
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    };

    let yama = shuffle([...tiles]);

    // ====== åˆæœŸåŒ– ======
    let playerHand = yama.splice(0, 13);
    let cpuHand = yama.splice(0, 13);
    let playerDiscards = [];
    let cpuDiscards = [];

    // ====== æ‰‹ç‰Œã‚½ãƒ¼ãƒˆé–¢æ•° ======
    function sortHand(hand) {
      const order = { m: 1, p: 2, s: 3 }; // è¬â†’ç­’â†’ç´¢
      const honorOrder = { E: 4, S: 5, W: 6, N: 7, H: 8, F: 9, C: 10 };

      return hand.sort((a, b) => {
        const aSuit = a[0], bSuit = b[0];
        const aNum = parseInt(a.slice(1)) || 0;
        const bNum = parseInt(b.slice(1)) || 0;

        // è¬ãƒ»ç­’ãƒ»ç´¢
        if (order[aSuit] && order[bSuit]) {
          if (order[aSuit] === order[bSuit]) return aNum - bNum;
          return order[aSuit] - order[bSuit];
        };

        // å­—ç‰Œã®å ´åˆ
        if (order[aSuit] && !order[bSuit]) return -1;
        if (!order[aSuit] && order[bSuit]) return 1;
        return (honorOrder[aSuit] || 99) - (honorOrder[bSuit] || 99);
      });
    };

    // ====== è¡¨ç¤ºæ›´æ–° ======
   // ====== ã‚ãŒã‚Šåˆ¤å®šï¼ˆ4é¢å­1é›€é ­ï¼‰ ======
    function isWinning(hand) {
      if (hand.length !== 14) return false;

      // ã‚«ã‚¦ãƒ³ãƒˆãƒãƒƒãƒ—ä½œæˆ
      let counts = {};
      hand.forEach(t => counts[t] = (counts[t] || 0) + 1);

      // ã™ã¹ã¦ã®å¯èƒ½ãªé›€é ­å€™è£œã‚’è©¦ã™
      for (let tile in counts) {
        if (counts[tile] >= 2) {
          counts[tile] -= 2;
          if (canFormMelds(JSON.parse(JSON.stringify(counts)))) {
            return true;
          };
          counts[tile] += 2;
        };
      };
      return false;
    };

    // å†å¸°çš„ã«é¢å­ã‚’ä½œã‚Œã‚‹ã‹ç¢ºèª
    function canFormMelds(counts) {
      const tiles = Object.keys(counts).filter(t => counts[t] > 0);
      if (tiles.length === 0) return true; // ã™ã¹ã¦ä½¿ã„åˆ‡ã£ãŸ

      const first = tiles[0];
      if (counts[first] >= 3) {
        counts[first] -= 3;
        if (canFormMelds(counts)) return true;
        counts[first] += 3;
      }

      // é †å­ï¼ˆåŒç¨®ã€é€£ç¶šæ•°å­—ï¼‰
      const suit = first[0];
      const num = parseInt(first.slice(1));
      if (suit !== 'E' && num && num <= 7) {
        const next1 = suit + (num + 1);
        const next2 = suit + (num + 2);
        if (counts[next1] > 0 && counts[next2] > 0) {
          counts[first]--; counts[next1]--; counts[next2]--;
          if (canFormMelds(counts)) return true;
          counts[first]++; counts[next1]++; counts[next2]++;
        }
      }
      return false;
    };

    // ====== è¡¨ç¤ºæ›´æ–° ======
    function render(message="") {
      const playerDiv=document.getElementById("player-hand");
      const cpuDiv=document.getElementById("cpu-hand");
      const playerDiscardDiv=document.getElementById("player-discards");
      const cpuDiscardDiv=document.getElementById("cpu-discards");
      const msgDiv=document.getElementById("message");

      playerHand=sortHand(playerHand);
      cpuHand=sortHand(cpuHand);

      playerDiv.innerHTML="";
      playerHand.forEach((tile,idx)=>{
        const div=document.createElement("div");
        div.className="tile";
        div.textContent=tileToEmoji(tile);
        div.onclick=()=>playerDiscard(idx);
        playerDiv.appendChild(div);
      });

      cpuDiv.innerHTML="";
      cpuHand.forEach(()=>{const d=document.createElement("div");d.className="tile";d.textContent="ğŸ€«";cpuDiv.appendChild(d);});

      playerDiscardDiv.innerHTML=playerDiscards.map(t=>`<div class="tile">${tileToEmoji(t)}</div>`).join("");
      cpuDiscardDiv.innerHTML=cpuDiscards.map(t=>`<div class="tile">${tileToEmoji(t)}</div>`).join("");
      msgDiv.textContent=message;
    };

    // ====== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¨ã¦ç‰Œ ===
    
    function render() {
      const playerDiv = document.getElementById("player-hand");
      const cpuDiv = document.getElementById("cpu-hand");
      const playerDiscardDiv = document.getElementById("player-discards");
      const cpuDiscardDiv = document.getElementById("cpu-discards");

      // ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
      playerHand = sortHand(playerHand);
      cpuHand = sortHand(cpuHand);

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ‰‹ç‰Œ
      playerDiv.innerHTML = "";
      playerHand.forEach((tile, idx) => {
        const div = document.createElement("div");
        div.className = "tile";
        div.textContent = tile;
        div.onclick = () => playerDiscard(idx);
        playerDiv.appendChild(div);
      });
       //===================ã€€è‡ªæ¨¡ã®åˆ¶é™ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ã€€======================
    document.getElementById("draw-btn").onclick = () => {
  if (yama.length === 0) return alert("å±±ãŒå°½ãã¾ã—ãŸï¼");
  if (playerHand.length !== 13) return alert("æ‰“ç‰Œã—ã¦ã‹ã‚‰ãƒ„ãƒ¢ã—ã¦ãã ã•ã„ï¼");
  const draw = yama.pop();
  playerHand.push(draw); // â†’ 14æšã«ãªã‚‹
  render();
};
    function playerDiscard(index) {
  if (playerHand.length !== 14) return alert("ãƒ„ãƒ¢ã—ã¦ã‹ã‚‰æ¨ã¦ã¦ãã ã•ã„ï¼");
  const discard = playerHand.splice(index, 1)[0];
  playerDiscards.push(discard);
  render();
  setTimeout(cpuTurn, 1000);
};

      // CPUæ‰‹ç‰Œï¼ˆè£ï¼‰
      cpuDiv.innerHTML = "";
      cpuHand.forEach(() => {
        const div = document.createElement("div");
        div.className = "tile";
        div.textContent = "ğŸ€«";
        cpuDiv.appendChild(div);
      });
    //===================ã€€è‡ªæ¨¡ã®åˆ¶é™ï¼ˆcpuï¼‰ã€€======================
function cpuTurn() {
  if (yama.length === 0) return alert("å±±ãŒå°½ãã¾ã—ãŸï¼");
  if (cpuHand.length !== 13) return; // CPUã‚‚13æšã®æ™‚ã ã‘ãƒ„ãƒ¢
  const draw = yama.pop();
  cpuHand.push(draw); // â†’ 14æš
  const discardIndex = Math.floor(Math.random() * cpuHand.length);
  const discard = cpuHand.splice(discardIndex, 1)[0]; // â†’ 13æšã«æˆ»ã‚‹
  cpuDiscards.push(discard);
  render();
   };

      // æ¨ã¦ç‰Œ
      playerDiscardDiv.innerHTML = playerDiscards.map(t => `<div class="tile">${t}</div>`).join("");
      cpuDiscardDiv.innerHTML = cpuDiscards.map(t => `<div class="tile">${t}</div>`).join("");
    };

    // ====== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¨ã¦ç‰Œ ======
    function playerDiscard(index) {
      const discard = playerHand.splice(index, 1)[0];
      playerDiscards.push(discard);
      render();
      setTimeout(cpuTurn, 1000);
    };

    // ====== CPUã‚¿ãƒ¼ãƒ³ ======
    function cpuTurn() {
      if (yama.length === 0) return alert("å±±ãŒå°½ãã¾ã—ãŸï¼");
      const draw = yama.pop();
      cpuHand.push(draw);
      const discardIndex = Math.floor(Math.random() * cpuHand.length);
      const discard = cpuHand.splice(discardIndex, 1)[0];
      cpuDiscards.push(discard); 
      render();
    };

    // ====== ãƒ„ãƒ¢ãƒœã‚¿ãƒ³ ======
    document.getElementById("draw-btn").onclick = () => {
      if (yama.length === 0) return alert("å±±ãŒå°½ãã¾ã—ãŸï¼");
      const draw = yama.pop();
      playerHand.push(draw);
      render();
    };

    // ====== åˆæœŸè¡¨ç¤º ======
    render();
  </script>
</body>
</html>